[
    {
        "id": "06c72d44e5729b2a",
        "type": "tab",
        "label": "wt: geofencing",
        "disabled": false,
        "info": "# localhost #1\n\n    `\n    prefetch data dari queue 1 message / 15 seconds\n    `\n\n# locahost #2\n\n    `\n    prefetch data dari queue 1 message / 5 seconds\n    `\n\n# locahost #3\n\n    `\n    prefetch data dari queue 1 message / 3 seconds\n    `\n\n# locahost:last\n\n    `\n    no prefetch for all flows\n    `\n\n// nrlint function-eslint:off\n",
        "env": []
    },
    {
        "id": "9ba7388927fccc31",
        "type": "tab",
        "label": "wt: series",
        "disabled": false,
        "info": "# localhost #1\n\n    `\n    prefetch data dari queue 1 message / 5 seconds\n    `\n\n# locahost #2\n\n    `\n    prefetch data dari queue 1 message / 17 seconds\n    `\n\n# localhost:last\n\n    `\n    no prefetch for all flows\n    `\n\n// nrlint function-eslint:off\n",
        "env": []
    },
    {
        "id": "2becf7ecab3a6f09",
        "type": "tab",
        "label": "vm: series",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "ef0e7b589320b81a",
        "type": "subflow",
        "name": "sub: couchdb-insert",
        "info": "# Input\n\n### msg.sub\n\n    {\n        database: 'smart-bucket',\n        doc: {}\n    }\n\n// nrlint function-eslint:off\n",
        "category": "",
        "in": [
            {
                "x": 60,
                "y": 80,
                "wires": [
                    {
                        "id": "6ae3265eb63f2da2"
                    }
                ]
            }
        ],
        "out": [
            {
                "x": 340,
                "y": 160,
                "wires": [
                    {
                        "id": "447e985e09671110",
                        "port": 0
                    }
                ]
            }
        ],
        "env": [],
        "meta": {},
        "color": "#FFAAAA"
    },
    {
        "id": "89ff6cae3b742adc",
        "type": "group",
        "z": "9ba7388927fccc31",
        "name": "wt: smarttimeseris to redistimeseries",
        "style": {
            "label": true,
            "fill": "#e3f3d3",
            "fill-opacity": "0.4",
            "color": "#ff0000",
            "stroke": "none"
        },
        "nodes": [
            "7caf168b939b9028",
            "bb6860a59623cd4b",
            "f449ebb8cc8d7088",
            "e057ad1e131c55ee",
            "3fcc35deba3e1da9",
            "bafc0bcaf316df35",
            "dce20e17ce373f6d",
            "55430bbd67084deb",
            "36bbf34f8f4ec2ac",
            "bd7d3d7fe33f261b"
        ],
        "x": 14,
        "y": 339,
        "w": 1072,
        "h": 242
    },
    {
        "id": "9f1e98d4426d35e3",
        "type": "group",
        "z": "06c72d44e5729b2a",
        "name": "wt: get divisions in estate and filter longlat by division",
        "style": {
            "label": true,
            "stroke": "none",
            "color": "#ff0000",
            "fill": "#c8e7a7",
            "fill-opacity": "0.5"
        },
        "nodes": [
            "e8c0683cc5f8df67",
            "8f24af074f1a443c",
            "73952f098b8ed22c",
            "bfe3ce28f29a69ae",
            "7bc55cf847260a66",
            "c2af8c09210a4097",
            "a682597d72837a54",
            "dfc98af8f801f8b3",
            "89a5b43359f7baa0",
            "19bc5810b2b9aee7",
            "7ab4d9e9b22d944d"
        ],
        "x": 34,
        "y": 39,
        "w": 872,
        "h": 242
    },
    {
        "id": "48e7b095e8d92958",
        "type": "group",
        "z": "9ba7388927fccc31",
        "name": "smartbucket.to.smarttimeseries",
        "style": {
            "stroke": "none",
            "fill": "#e3f3d3",
            "fill-opacity": "0.45",
            "label": true,
            "color": "#ff3f3f"
        },
        "nodes": [
            "e3a50e6cb96cc3b3",
            "dd42509446494f20",
            "248c25e4d88ba52f",
            "c7bc8f0da817a8a1",
            "1035dda52d64f81f",
            "d2ee66a5416bd52f"
        ],
        "x": 14,
        "y": 79,
        "w": 832,
        "h": 202
    },
    {
        "id": "bf7019fa94e27678",
        "type": "group",
        "z": "06c72d44e5729b2a",
        "name": "wt: job from division",
        "style": {
            "label": true,
            "stroke": "none",
            "fill": "#c8e7a7",
            "fill-opacity": "0.5",
            "color": "#ff3f3f"
        },
        "nodes": [
            "d18b39342c8a59d3",
            "61a97b32b17dbf53",
            "ba50707f8350607b",
            "583c321e926a7194",
            "07e925cecf4e0f11",
            "75ddc81655b011e5",
            "8294a49c8a909b6f",
            "f837821d76ab526d",
            "4a5542470e78ff1f",
            "aaf76430a76d8abc"
        ],
        "x": 34,
        "y": 319,
        "w": 792,
        "h": 242
    },
    {
        "id": "675a034d3ec876e6",
        "type": "group",
        "z": "06c72d44e5729b2a",
        "name": "wt: filter longlat by block",
        "style": {
            "label": true,
            "stroke": "none",
            "fill": "#c8e7a7",
            "fill-opacity": "0.48",
            "color": "#ff3f3f"
        },
        "nodes": [
            "ba3d896fdaf8eaeb",
            "b387dc3b8e3ba31b",
            "62a7d89a51841542",
            "3e8b4e6ffc5eb9a4",
            "f27b55e10b676cbc",
            "556efb3bcd5fb373",
            "46f35e50e7239b03",
            "8ab2f8087937a815",
            "bafc614fbcb82f02"
        ],
        "x": 34,
        "y": 599,
        "w": 992,
        "h": 182
    },
    {
        "id": "8913e09cb6434789",
        "type": "group",
        "z": "06c72d44e5729b2a",
        "name": "wt: filter longlat by trees inside block",
        "style": {
            "label": true,
            "stroke": "none",
            "fill": "#c8e7a7",
            "fill-opacity": "0.48",
            "color": "#ff3f3f"
        },
        "nodes": [
            "b765932bf69d2d0f",
            "2da97027bd0d7c7a",
            "9650f01883ca82d9",
            "084f166599dd9ab2",
            "5a370e3921d66ad8",
            "6d5542a7141c4672",
            "eb6b615b54e9fd61",
            "32bb7db17bf0aae4"
        ],
        "x": 34,
        "y": 819,
        "w": 952,
        "h": 142
    },
    {
        "id": "96db80cb3d51c6c6",
        "type": "group",
        "z": "06c72d44e5729b2a",
        "name": "wt: geofencing and create transaction",
        "style": {
            "stroke": "none",
            "fill": "#c8e7a7",
            "fill-opacity": "0.45",
            "label": true,
            "color": "#ff3f3f"
        },
        "nodes": [
            "996035da1afdd16a",
            "909f0bae520fb673",
            "d821f6f9cad4c1e3",
            "652a4d3ed7d3a711",
            "2e87f501b0a0f94b",
            "c88815bdc277d475",
            "aee9d1bce03f6042",
            "7470e87bc569f9a8"
        ],
        "x": 34,
        "y": 999,
        "w": 892,
        "h": 142
    },
    {
        "id": "e907ba5364e5896f",
        "type": "amqp-server",
        "z": "9ba7388927fccc31",
        "host": "${BROKER_DOMAIN}",
        "port": "${BROKER_PORT}",
        "vhost": "",
        "keepalive": "30",
        "usetls": false,
        "verifyservercert": true,
        "useca": false,
        "ca": "",
        "usetopology": false,
        "topology": "{\n\t\"exchanges\": [\n\t\t{\"name\": \"exchange1\", \"type\": \"direct\", \"options\": {\"durable\": false}},\n\t\t{\"name\": \"exchange2\"}\n\t],\n\t\"queues\": [\n\t\t{\"name\": \"queue1\", \"options\": {\"messageTtl\": 60000}},\n\t\t{\"name\": \"queue2\"}\n\t],\n\t\"bindings\": [\n\t\t{\"source\": \"exchange1\", \"queue\": \"queue1\", \"pattern\": \"debug\", \"args\": {}},\n\t\t{\"source\": \"exchange1\", \"exchange\": \"exchange2\", \"pattern\": \"error\"},\n\t\t{\"source\": \"exchange2\", \"queue\": \"queue2\"}\n\t]\n}",
        "prefetch": true,
        "prefetchvalue": "1",
        "prefetchack": true,
        "prefetchvalueack": "5000"
    },
    {
        "id": "70620c4aa929b5d8",
        "type": "amqp-server",
        "z": "06c72d44e5729b2a",
        "host": "${BROKER_DOMAIN}",
        "port": "${BROKER_PORT}",
        "vhost": "",
        "keepalive": "30",
        "usetls": false,
        "verifyservercert": true,
        "useca": false,
        "ca": "",
        "usetopology": false,
        "topology": "{\n\t\"exchanges\": [\n\t\t{\"name\": \"exchange1\", \"type\": \"direct\", \"options\": {\"durable\": false}},\n\t\t{\"name\": \"exchange2\"}\n\t],\n\t\"queues\": [\n\t\t{\"name\": \"queue1\", \"options\": {\"messageTtl\": 60000}},\n\t\t{\"name\": \"queue2\"}\n\t],\n\t\"bindings\": [\n\t\t{\"source\": \"exchange1\", \"queue\": \"queue1\", \"pattern\": \"debug\", \"args\": {}},\n\t\t{\"source\": \"exchange1\", \"exchange\": \"exchange2\", \"pattern\": \"error\"},\n\t\t{\"source\": \"exchange2\", \"queue\": \"queue2\"}\n\t]\n}",
        "prefetch": false,
        "prefetchvalue": "1",
        "prefetchack": false,
        "prefetchvalueack": "10"
    },
    {
        "id": "56e870f2a20cabb0",
        "type": "amqp-server",
        "z": "9ba7388927fccc31",
        "host": "${BROKER_DOMAIN}",
        "port": "${BROKER_PORT}",
        "vhost": "",
        "keepalive": "30",
        "usetls": false,
        "verifyservercert": true,
        "useca": false,
        "ca": "",
        "usetopology": false,
        "topology": "{\n\t\"exchanges\": [\n\t\t{\"name\": \"exchange1\", \"type\": \"direct\", \"options\": {\"durable\": false}},\n\t\t{\"name\": \"exchange2\"}\n\t],\n\t\"queues\": [\n\t\t{\"name\": \"queue1\", \"options\": {\"messageTtl\": 60000}},\n\t\t{\"name\": \"queue2\"}\n\t],\n\t\"bindings\": [\n\t\t{\"source\": \"exchange1\", \"queue\": \"queue1\", \"pattern\": \"debug\", \"args\": {}},\n\t\t{\"source\": \"exchange1\", \"exchange\": \"exchange2\", \"pattern\": \"error\"},\n\t\t{\"source\": \"exchange2\", \"queue\": \"queue2\"}\n\t]\n}",
        "prefetch": true,
        "prefetchvalue": "1",
        "prefetchack": true,
        "prefetchvalueack": "10000"
    },
    {
        "id": "5471df75ac676292",
        "type": "amqp-server",
        "z": "9ba7388927fccc31",
        "host": "${BROKER_DOMAIN}",
        "port": "${BROKER_PORT}",
        "vhost": "",
        "keepalive": "30",
        "usetls": false,
        "verifyservercert": true,
        "useca": false,
        "ca": "",
        "usetopology": false,
        "topology": "{\n\t\"exchanges\": [\n\t\t{\"name\": \"exchange1\", \"type\": \"direct\", \"options\": {\"durable\": false}},\n\t\t{\"name\": \"exchange2\"}\n\t],\n\t\"queues\": [\n\t\t{\"name\": \"queue1\", \"options\": {\"messageTtl\": 60000}},\n\t\t{\"name\": \"queue2\"}\n\t],\n\t\"bindings\": [\n\t\t{\"source\": \"exchange1\", \"queue\": \"queue1\", \"pattern\": \"debug\", \"args\": {}},\n\t\t{\"source\": \"exchange1\", \"exchange\": \"exchange2\", \"pattern\": \"error\"},\n\t\t{\"source\": \"exchange2\", \"queue\": \"queue2\"}\n\t]\n}",
        "prefetch": true,
        "prefetchvalue": "1",
        "prefetchack": true,
        "prefetchvalueack": "5000"
    },
    {
        "id": "0a8b482f55e0592d",
        "type": "amqp-server",
        "z": "06c72d44e5729b2a",
        "host": "${BROKER_DOMAIN}",
        "port": "${BROKER_PORT}",
        "vhost": "",
        "keepalive": "30",
        "usetls": false,
        "verifyservercert": true,
        "useca": false,
        "ca": "",
        "usetopology": false,
        "topology": "{\n\t\"exchanges\": [\n\t\t{\"name\": \"exchange1\", \"type\": \"direct\", \"options\": {\"durable\": false}},\n\t\t{\"name\": \"exchange2\"}\n\t],\n\t\"queues\": [\n\t\t{\"name\": \"queue1\", \"options\": {\"messageTtl\": 60000}},\n\t\t{\"name\": \"queue2\"}\n\t],\n\t\"bindings\": [\n\t\t{\"source\": \"exchange1\", \"queue\": \"queue1\", \"pattern\": \"debug\", \"args\": {}},\n\t\t{\"source\": \"exchange1\", \"exchange\": \"exchange2\", \"pattern\": \"error\"},\n\t\t{\"source\": \"exchange2\", \"queue\": \"queue2\"}\n\t]\n}",
        "prefetch": true,
        "prefetchvalue": "1",
        "prefetchack": false,
        "prefetchvalueack": "20000"
    },
    {
        "id": "8dad4b74fb298592",
        "type": "amqp-server",
        "z": "06c72d44e5729b2a",
        "host": "${BROKER_DOMAIN}",
        "port": "${BROKER_PORT}",
        "vhost": "",
        "keepalive": "30",
        "usetls": false,
        "verifyservercert": true,
        "useca": false,
        "ca": "",
        "usetopology": false,
        "topology": "{\n\t\"exchanges\": [\n\t\t{\"name\": \"exchange1\", \"type\": \"direct\", \"options\": {\"durable\": false}},\n\t\t{\"name\": \"exchange2\"}\n\t],\n\t\"queues\": [\n\t\t{\"name\": \"queue1\", \"options\": {\"messageTtl\": 60000}},\n\t\t{\"name\": \"queue2\"}\n\t],\n\t\"bindings\": [\n\t\t{\"source\": \"exchange1\", \"queue\": \"queue1\", \"pattern\": \"debug\", \"args\": {}},\n\t\t{\"source\": \"exchange1\", \"exchange\": \"exchange2\", \"pattern\": \"error\"},\n\t\t{\"source\": \"exchange2\", \"queue\": \"queue2\"}\n\t]\n}",
        "prefetch": true,
        "prefetchvalue": "1",
        "prefetchack": false,
        "prefetchvalueack": "10"
    },
    {
        "id": "f7b36a35cf0d6417",
        "type": "amqp-server",
        "z": "9ba7388927fccc31",
        "host": "${BROKER_DOMAIN}",
        "port": "${BROKER_PORT}",
        "vhost": "",
        "keepalive": "30",
        "usetls": false,
        "verifyservercert": true,
        "useca": false,
        "ca": "",
        "usetopology": false,
        "topology": "{\n\t\"exchanges\": [\n\t\t{\"name\": \"exchange1\", \"type\": \"direct\", \"options\": {\"durable\": false}},\n\t\t{\"name\": \"exchange2\"}\n\t],\n\t\"queues\": [\n\t\t{\"name\": \"queue1\", \"options\": {\"messageTtl\": 60000}},\n\t\t{\"name\": \"queue2\"}\n\t],\n\t\"bindings\": [\n\t\t{\"source\": \"exchange1\", \"queue\": \"queue1\", \"pattern\": \"debug\", \"args\": {}},\n\t\t{\"source\": \"exchange1\", \"exchange\": \"exchange2\", \"pattern\": \"error\"},\n\t\t{\"source\": \"exchange2\", \"queue\": \"queue2\"}\n\t]\n}",
        "prefetch": false,
        "prefetchvalue": "1",
        "prefetchack": false,
        "prefetchvalueack": "10"
    },
    {
        "id": "7a8729d72f970b40",
        "type": "amqp-server",
        "z": "06c72d44e5729b2a",
        "host": "${BROKER_DOMAIN}",
        "port": "${BROKER_PORT}",
        "vhost": "",
        "keepalive": "30",
        "usetls": false,
        "verifyservercert": true,
        "useca": false,
        "ca": "",
        "usetopology": false,
        "topology": "{\n\t\"exchanges\": [\n\t\t{\"name\": \"exchange1\", \"type\": \"direct\", \"options\": {\"durable\": false}},\n\t\t{\"name\": \"exchange2\"}\n\t],\n\t\"queues\": [\n\t\t{\"name\": \"queue1\", \"options\": {\"messageTtl\": 60000}},\n\t\t{\"name\": \"queue2\"}\n\t],\n\t\"bindings\": [\n\t\t{\"source\": \"exchange1\", \"queue\": \"queue1\", \"pattern\": \"debug\", \"args\": {}},\n\t\t{\"source\": \"exchange1\", \"exchange\": \"exchange2\", \"pattern\": \"error\"},\n\t\t{\"source\": \"exchange2\", \"queue\": \"queue2\"}\n\t]\n}",
        "prefetch": true,
        "prefetchvalue": "5",
        "prefetchack": false,
        "prefetchvalueack": "10"
    },
    {
        "id": "94497583e5725ee2",
        "type": "amqp-server",
        "host": "${BROKER_DOMAIN}",
        "port": "${BROKER_PORT}",
        "vhost": "",
        "keepalive": "30",
        "usetls": false,
        "verifyservercert": true,
        "useca": false,
        "ca": "",
        "usetopology": false,
        "topology": "{\n\t\"exchanges\": [\n\t\t{\"name\": \"exchange1\", \"type\": \"direct\", \"options\": {\"durable\": false}},\n\t\t{\"name\": \"exchange2\"}\n\t],\n\t\"queues\": [\n\t\t{\"name\": \"queue1\", \"options\": {\"messageTtl\": 60000}},\n\t\t{\"name\": \"queue2\"}\n\t],\n\t\"bindings\": [\n\t\t{\"source\": \"exchange1\", \"queue\": \"queue1\", \"pattern\": \"debug\", \"args\": {}},\n\t\t{\"source\": \"exchange1\", \"exchange\": \"exchange2\", \"pattern\": \"error\"},\n\t\t{\"source\": \"exchange2\", \"queue\": \"queue2\"}\n\t]\n}",
        "prefetch": true,
        "prefetchvalue": "1",
        "prefetchack": false,
        "prefetchvalueack": "10"
    },
    {
        "id": "73a503547a572f1b",
        "type": "amqp-server",
        "z": "06c72d44e5729b2a",
        "host": "${BROKER_DOMAIN}",
        "port": "${BROKER_PORT}",
        "vhost": "",
        "keepalive": "30",
        "usetls": false,
        "verifyservercert": true,
        "useca": false,
        "ca": "",
        "usetopology": false,
        "topology": "{\n\t\"exchanges\": [\n\t\t{\"name\": \"exchange1\", \"type\": \"direct\", \"options\": {\"durable\": false}},\n\t\t{\"name\": \"exchange2\"}\n\t],\n\t\"queues\": [\n\t\t{\"name\": \"queue1\", \"options\": {\"messageTtl\": 60000}},\n\t\t{\"name\": \"queue2\"}\n\t],\n\t\"bindings\": [\n\t\t{\"source\": \"exchange1\", \"queue\": \"queue1\", \"pattern\": \"debug\", \"args\": {}},\n\t\t{\"source\": \"exchange1\", \"exchange\": \"exchange2\", \"pattern\": \"error\"},\n\t\t{\"source\": \"exchange2\", \"queue\": \"queue2\"}\n\t]\n}",
        "prefetch": true,
        "prefetchvalue": "1",
        "prefetchack": false,
        "prefetchvalueack": "10"
    },
    {
        "id": "e42544d355f50764",
        "type": "http request",
        "z": "ef0e7b589320b81a",
        "name": "",
        "method": "POST",
        "ret": "txt",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 210,
        "y": 120,
        "wires": [
            [
                "447e985e09671110"
            ]
        ]
    },
    {
        "id": "6ae3265eb63f2da2",
        "type": "function",
        "z": "ef0e7b589320b81a",
        "name": "read sub",
        "func": "msg.backup = msg.payload;\n\nlet { database, doc } = msg.sub;\nmsg.payload = doc;\nmsg.headers = {\n    \"Authorization\": \"Basic \" +\n        Buffer.from(`${env.get('DOCS_MASTER_USER')}:${env.get('DOCS_MASTER_PASSWORD')}`).toString(\"base64\"),\n    \"Content-Type\": \"application/json; charset=utf-8\"\n}\nmsg.url = `${env.get('DOC_MASTER_DOMAIN')}/${database}`;\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 200,
        "y": 80,
        "wires": [
            [
                "e42544d355f50764"
            ]
        ]
    },
    {
        "id": "447e985e09671110",
        "type": "function",
        "z": "ef0e7b589320b81a",
        "name": "result",
        "func": "msg.sub = JSON.parse(msg.payload);\nmsg.payload = msg.backup;\ndelete msg.backup;\ndelete msg.url;\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 190,
        "y": 160,
        "wires": [
            []
        ]
    },
    {
        "id": "e8c0683cc5f8df67",
        "type": "function",
        "z": "06c72d44e5729b2a",
        "g": "9f1e98d4426d35e3",
        "name": "send to worker",
        "func": "try {\n    if (msg.error) {\n        node.send(msg);\n        return;\n    }\n    let w = global.get('worker');\n    let worker = new w.Worker('./workers/w-geo.js');\n    let { date, series } = msg.payload;\n    let [ident, tracking] = series;\n\n    worker.on('message', (result) => {\n        worker.terminate();\n        let { area, tracking } = result.data;\n        if (Array.isArray(tracking) && tracking.length > 0) {\n            node.send({\n                payload: { date, ident, area, tracking }\n            });\n        }\n    });\n    worker.on('error', (err) => {\n        worker.terminate();\n        node.error({ segment: 'tracking.perdevice', err });\n    })\n\n    worker.postMessage({\n        func: 'checkLocationsInMultiPloygon',\n        payload: {\n            locations: tracking,\n            multiPolygon: msg.geoDivision\n        }\n    });\n} catch (err) {\n    node.error({ segment: 'tracking.perdevice', err });\n}",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 520,
        "y": 240,
        "wires": [
            [
                "7bc55cf847260a66"
            ]
        ],
        "icon": "font-awesome/fa-qrcode"
    },
    {
        "id": "8f24af074f1a443c",
        "type": "function",
        "z": "06c72d44e5729b2a",
        "g": "9f1e98d4426d35e3",
        "name": "get SMSE divisions geojson >> foreach",
        "func": "const couchdb = global.get('couchdb');\nlet ori = msg;\nlet payload = msg.payload;\ntry {\n    couchdb.view('smart-geojson', 'division', 'geo-by-estate', {\n        key: ['PSM 2', \"SMSE\"]\n    }).then(res => {\n        res.data.rows.map(x => x.value).forEach(div => {\n            node.send({\n                payload,\n                geoDivision: div\n            });\n        });\n        node.send({ ack: true, ...ori }); /**acknowledge */\n    }, (err) => {\n        node.error({ segment: 'tracking.perdevice', err });\n        node.send({\n            ack: false,\n            ori,\n            error: err,\n        })\n    })\n} catch (err) {\n    node.error({ segment: 'tracking.perdevice', err });\n    node.send({\n        ack: false,\n        ori,\n        error: err,\n    })\n}",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 220,
        "y": 160,
        "wires": [
            [
                "c2af8c09210a4097",
                "89a5b43359f7baa0"
            ]
        ],
        "icon": "font-awesome/fa-code-fork"
    },
    {
        "id": "73952f098b8ed22c",
        "type": "amqp in",
        "z": "06c72d44e5729b2a",
        "g": "9f1e98d4426d35e3",
        "name": "",
        "topic": "",
        "iotype": "4",
        "ioname": "wt.tracking.perdevice",
        "server": "0a8b482f55e0592d",
        "x": 160,
        "y": 80,
        "wires": [
            [
                "bfe3ce28f29a69ae"
            ]
        ]
    },
    {
        "id": "d18b39342c8a59d3",
        "type": "amqp in",
        "z": "06c72d44e5729b2a",
        "g": "bf7019fa94e27678",
        "name": "",
        "topic": "",
        "iotype": "4",
        "ioname": "wt.tracking.filterby.division",
        "server": "8dad4b74fb298592",
        "x": 170,
        "y": 360,
        "wires": [
            [
                "ba50707f8350607b"
            ]
        ]
    },
    {
        "id": "61a97b32b17dbf53",
        "type": "function",
        "z": "06c72d44e5729b2a",
        "g": "bf7019fa94e27678",
        "name": "get block geojson >> foreach",
        "func": "const couchdb = global.get('couchdb');\nlet ori = msg;\nlet { date, ident, area, tracking } = msg.payload;\nlet { psm, estate, division } = area;\n\ncouchdb.view('smart-geojson', 'block', 'geo-by-division', {\n    key: [psm, estate, division]\n}).then(res => {\n    res.data.rows.map(x => x.value).forEach(block => {\n        node.send({\n            payload: { date, ident, tracking, block }\n        });\n    });\n    node.send({ ack: true, ...ori }); /**acknowledge */\n}, (err) => {\n    node.error({ segment: 'filterby.division', err });\n    node.send({\n        error: err,\n        ack: false,\n        ori\n    })\n})\nreturn null;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 180,
        "y": 440,
        "wires": [
            [
                "4a5542470e78ff1f",
                "aaf76430a76d8abc"
            ]
        ],
        "icon": "font-awesome/fa-code-fork"
    },
    {
        "id": "ba3d896fdaf8eaeb",
        "type": "amqp in",
        "z": "06c72d44e5729b2a",
        "g": "675a034d3ec876e6",
        "name": "",
        "topic": "",
        "iotype": "4",
        "ioname": "wt.tracking.filterby.block",
        "server": "7a8729d72f970b40",
        "x": 170,
        "y": 640,
        "wires": [
            [
                "62a7d89a51841542"
            ]
        ]
    },
    {
        "id": "b387dc3b8e3ba31b",
        "type": "function",
        "z": "06c72d44e5729b2a",
        "g": "675a034d3ec876e6",
        "name": "send to worker",
        "func": "let ori = msg;\ntry {\n    let w = global.get('worker');\n    let worker = new w.Worker('./workers/w-geo.js');\n    let { date, ident, tracking, block } = msg.payload;\n\n    // Send a message to the worker thread\n    worker.postMessage({\n        func: 'checkLocationsInPloygon',\n        payload: {\n            locations: tracking,\n            geojson: block\n        }\n    });\n\n    worker.on('message', (result) => {\n        worker.terminate();\n        let { area, tracking } = result.data;\n        if (Array.isArray(tracking) && tracking.length > 0) {\n            node.send({\n                payload: {\n                    date,\n                    ident,\n                    area,\n                    tracking\n                },\n                ack: true,\n                ori\n            });\n        }\n    });\n\n    worker.on('error', (err) => {\n        worker.terminate();\n        node.error({ segment: 'filterby.block', err });\n        node.send({\n            error: err,\n            ack: false,\n            ori\n        })\n    });\n} catch (err) {\n    node.error({ segment: 'filterby.block', err });\n    node.send({\n        error: err,\n        ack: false,\n        ori\n    })\n}",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 440,
        "y": 660,
        "wires": [
            [
                "bafc614fbcb82f02"
            ]
        ],
        "icon": "font-awesome/fa-qrcode"
    },
    {
        "id": "b765932bf69d2d0f",
        "type": "amqp in",
        "z": "06c72d44e5729b2a",
        "g": "8913e09cb6434789",
        "name": "",
        "topic": "",
        "iotype": "4",
        "ioname": "wt.tracking.filterby.tree",
        "server": "94497583e5725ee2",
        "x": 160,
        "y": 860,
        "wires": [
            [
                "9650f01883ca82d9"
            ]
        ]
    },
    {
        "id": "2da97027bd0d7c7a",
        "type": "function",
        "z": "06c72d44e5729b2a",
        "g": "8913e09cb6434789",
        "name": "get tree geojson",
        "func": "let ori = msg;\nlet payload = msg.payload;\ntry {\n    const couchdb = global.get('couchdb');\n    let w = global.get('worker');\n    let worker = new w.Worker('./workers/w-geo.js');\n\n    let { date, ident, area, tracking } = payload;\n    let { psm, estate, division, block } = area;\n    couchdb.view('smart-geojson', 'tree', 'geo-by-block', {\n        key: [psm, estate, division, block]\n    }).then(res => {\n        let geoTree = res.data.rows?.map(x => x.value);\n        if (Array.isArray(geoTree) && geoTree.length > 0) {\n            worker.postMessage({\n                func: 'checkLocationsInPoints',\n                payload: {\n                    locations: tracking,\n                    points: geoTree,\n                    radius: 4,\n                    steps: 18\n                }\n            });\n        }\n    }, (err) => {\n        node.error({ segment: 'filterby.tree', err });\n        node.send({\n            error: err,\n            ack: false,\n            ori\n        })\n    });\n\n    worker.on('message', (res) => {\n        worker.terminate();\n        let inRange = res.data;\n        if (res.data && Array.isArray(inRange) && inRange.length > 0) {\n            let docs = inRange.map(x => {\n                return { date, ident, ...x }\n            })\n            couchdb.bulk('temp', docs)\n                .then(\n                    () => {\n                        node.send({ ack: true, ...ori }); /**acknowledge */\n                    }, err => {\n                        node.error({ segment: 'filterby.tree:bulk-insert', err });\n                        node.send({\n                            error: err,\n                            ack: false,\n                            ori\n                        });\n                    });\n        }\n    });\n    worker.on('error', (err) => {\n        worker.terminate();\n        node.error({ segment: 'filterby.tree:worker-error', err });\n        node.send({\n            error: err,\n            ack: false,\n            ori\n        });\n    });\n} catch (err) {\n    node.error({ segment: 'filterby.tree', err });\n    node.send({\n        error: err,\n        ack: false,\n        ori\n    });\n}",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 420,
        "y": 860,
        "wires": [
            [
                "084f166599dd9ab2"
            ]
        ],
        "icon": "font-awesome/fa-braille"
    },
    {
        "id": "996035da1afdd16a",
        "type": "amqp in",
        "z": "06c72d44e5729b2a",
        "d": true,
        "g": "96db80cb3d51c6c6",
        "name": "",
        "topic": "",
        "iotype": "4",
        "ioname": "wt.transaction",
        "server": "73a503547a572f1b",
        "x": 140,
        "y": 1040,
        "wires": [
            [
                "652a4d3ed7d3a711"
            ]
        ]
    },
    {
        "id": "909f0bae520fb673",
        "type": "function",
        "z": "06c72d44e5729b2a",
        "g": "96db80cb3d51c6c6",
        "name": "create transactions",
        "func": "let ori = msg.payload;\ntry {\n    const couchdb = global.get('couchdb');\n    let { date, ident, geofencing } = msg.payload;\n    let [nik, device, imei] = ident;\n    couchdb.view('transactions', 'filter', 'by-harvester-date', {\n        key: [ident[0], date]\n    }).then(res => {\n        let rs = [];\n        let existing = res.data.rows?.map(x => x.value);\n        geofencing.forEach(geof => {\n            let { psm, estate, division, block, tree, timestamp, event } = geof;\n            let transaction = existing.find(x => x.treeID == tree);\n            let isHarvested = Number(event) > 0;\n            if (!transaction) {\n                rs.push({\n                    treeID: tree,\n                    psm: psm,\n                    estate: estate,\n                    division: division,\n                    block: block,\n                    harvester: nik,\n                    harvested: Number(event),\n                    lastHarvested: (isHarvested) ? new Date(timestamp) : null,\n                    visited: 1,\n                    lastVisited: new Date(timestamp),\n                    createdBy: \"system\",\n                    createdDate: new Date(),\n                    modifiedBy: \"system\",\n                    modifiedDate: new Date(),\n                });\n            } else {\n                if (isHarvested) {\n                    transaction.harvested += Number(event);\n                    transaction.lastHarvested = new Date(timestamp);\n                }\n                transaction.visited++;\n                rs.push(transaction);\n            }\n        });\n        couchdb.bulk('transactions', rs).then(res => {\n            node.send({\n                payload: res.data,\n                ori\n            });\n        }, (err) => {\n            node.send({\n                error: err,\n                sendBack: true,\n                ori\n            })\n        });\n        node.send(msg);\n    }, (err) => {\n        node.send({\n            error: err,\n            sendBack: true,\n            ori\n        })\n    });\n} catch (err) {\n    node.send({\n        error: err,\n        sendBack: true,\n        ori\n    })\n}",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 390,
        "y": 1040,
        "wires": [
            [
                "d821f6f9cad4c1e3"
            ]
        ]
    },
    {
        "id": "d821f6f9cad4c1e3",
        "type": "switch",
        "z": "06c72d44e5729b2a",
        "g": "96db80cb3d51c6c6",
        "name": "error ? ",
        "property": "sendBack",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 430,
        "y": 1080,
        "wires": [
            [
                "2e87f501b0a0f94b"
            ],
            [
                "aee9d1bce03f6042"
            ]
        ]
    },
    {
        "id": "bfe3ce28f29a69ae",
        "type": "delay",
        "z": "06c72d44e5729b2a",
        "g": "9f1e98d4426d35e3",
        "name": "",
        "pauseType": "delay",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 120,
        "y": 120,
        "wires": [
            [
                "8f24af074f1a443c"
            ]
        ]
    },
    {
        "id": "7bc55cf847260a66",
        "type": "amqp out",
        "z": "06c72d44e5729b2a",
        "g": "9f1e98d4426d35e3",
        "name": "",
        "routingkey": "",
        "iotype": "4",
        "ioname": "wt.tracking.filterby.division",
        "server": "70620c4aa929b5d8",
        "x": 770,
        "y": 240,
        "wires": []
    },
    {
        "id": "ba50707f8350607b",
        "type": "delay",
        "z": "06c72d44e5729b2a",
        "g": "bf7019fa94e27678",
        "name": "",
        "pauseType": "delay",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 120,
        "y": 400,
        "wires": [
            [
                "61a97b32b17dbf53"
            ]
        ]
    },
    {
        "id": "583c321e926a7194",
        "type": "amqp ack",
        "z": "06c72d44e5729b2a",
        "g": "bf7019fa94e27678",
        "name": "",
        "topic": "",
        "iotype": "4",
        "ioname": "wt.tracking.filterby.division",
        "nack": true,
        "server": "8dad4b74fb298592",
        "x": 690,
        "y": 480,
        "wires": [
            []
        ]
    },
    {
        "id": "07e925cecf4e0f11",
        "type": "function",
        "z": "06c72d44e5729b2a",
        "g": "bf7019fa94e27678",
        "name": "not acknowlege",
        "func": "msg = msg.ori;\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 660,
        "y": 440,
        "wires": [
            [
                "583c321e926a7194"
            ]
        ]
    },
    {
        "id": "75ddc81655b011e5",
        "type": "amqp ack",
        "z": "06c72d44e5729b2a",
        "g": "bf7019fa94e27678",
        "name": "",
        "topic": "",
        "iotype": "4",
        "ioname": "wt.tracking.filterby.division",
        "nack": false,
        "server": "8dad4b74fb298592",
        "x": 690,
        "y": 400,
        "wires": [
            []
        ]
    },
    {
        "id": "8294a49c8a909b6f",
        "type": "function",
        "z": "06c72d44e5729b2a",
        "g": "bf7019fa94e27678",
        "name": "acknowlege",
        "func": "msg = msg.ori;\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 650,
        "y": 360,
        "wires": [
            [
                "75ddc81655b011e5"
            ]
        ]
    },
    {
        "id": "f837821d76ab526d",
        "type": "amqp out",
        "z": "06c72d44e5729b2a",
        "g": "bf7019fa94e27678",
        "name": "",
        "routingkey": "",
        "iotype": "4",
        "ioname": "wt.tracking.filterby.block",
        "server": "70620c4aa929b5d8",
        "x": 470,
        "y": 520,
        "wires": []
    },
    {
        "id": "62a7d89a51841542",
        "type": "delay",
        "z": "06c72d44e5729b2a",
        "g": "675a034d3ec876e6",
        "name": "",
        "pauseType": "delay",
        "timeout": "3",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 220,
        "y": 680,
        "wires": [
            [
                "b387dc3b8e3ba31b"
            ]
        ]
    },
    {
        "id": "3e8b4e6ffc5eb9a4",
        "type": "function",
        "z": "06c72d44e5729b2a",
        "g": "675a034d3ec876e6",
        "name": "not acknowlege",
        "func": "msg = msg.ori;\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 660,
        "y": 740,
        "wires": [
            [
                "f27b55e10b676cbc"
            ]
        ]
    },
    {
        "id": "f27b55e10b676cbc",
        "type": "amqp ack",
        "z": "06c72d44e5729b2a",
        "g": "675a034d3ec876e6",
        "name": "",
        "topic": "",
        "iotype": "4",
        "ioname": "wt.tracking.filterby.block",
        "nack": true,
        "server": "7a8729d72f970b40",
        "x": 890,
        "y": 740,
        "wires": [
            []
        ]
    },
    {
        "id": "556efb3bcd5fb373",
        "type": "function",
        "z": "06c72d44e5729b2a",
        "g": "675a034d3ec876e6",
        "name": "acknowlege",
        "func": "msg = msg.ori;\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 650,
        "y": 660,
        "wires": [
            [
                "46f35e50e7239b03"
            ]
        ]
    },
    {
        "id": "46f35e50e7239b03",
        "type": "amqp ack",
        "z": "06c72d44e5729b2a",
        "g": "675a034d3ec876e6",
        "name": "",
        "topic": "",
        "iotype": "4",
        "ioname": "wt.tracking.filterby.block",
        "nack": false,
        "server": "7a8729d72f970b40",
        "x": 870,
        "y": 660,
        "wires": [
            []
        ]
    },
    {
        "id": "8ab2f8087937a815",
        "type": "amqp out",
        "z": "06c72d44e5729b2a",
        "g": "675a034d3ec876e6",
        "name": "",
        "routingkey": "",
        "iotype": "4",
        "ioname": "wt.tracking.filterby.tree",
        "server": "70620c4aa929b5d8",
        "x": 680,
        "y": 700,
        "wires": []
    },
    {
        "id": "9650f01883ca82d9",
        "type": "delay",
        "z": "06c72d44e5729b2a",
        "g": "8913e09cb6434789",
        "name": "",
        "pauseType": "delay",
        "timeout": "1",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 200,
        "y": 900,
        "wires": [
            [
                "2da97027bd0d7c7a"
            ]
        ]
    },
    {
        "id": "652a4d3ed7d3a711",
        "type": "delay",
        "z": "06c72d44e5729b2a",
        "g": "96db80cb3d51c6c6",
        "name": "",
        "pauseType": "delay",
        "timeout": "5",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 160,
        "y": 1080,
        "wires": [
            [
                "909f0bae520fb673"
            ]
        ]
    },
    {
        "id": "2e87f501b0a0f94b",
        "type": "function",
        "z": "06c72d44e5729b2a",
        "g": "96db80cb3d51c6c6",
        "name": "not acknowlege",
        "func": "msg = msg.ori;\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 620,
        "y": 1060,
        "wires": [
            [
                "c88815bdc277d475"
            ]
        ]
    },
    {
        "id": "c88815bdc277d475",
        "type": "amqp ack",
        "z": "06c72d44e5729b2a",
        "g": "96db80cb3d51c6c6",
        "name": "",
        "topic": "",
        "iotype": "4",
        "ioname": "wt.transaction",
        "nack": true,
        "server": "73a503547a572f1b",
        "x": 820,
        "y": 1060,
        "wires": [
            []
        ]
    },
    {
        "id": "aee9d1bce03f6042",
        "type": "function",
        "z": "06c72d44e5729b2a",
        "g": "96db80cb3d51c6c6",
        "name": "acknowlege",
        "func": "msg = msg.ori;\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 610,
        "y": 1100,
        "wires": [
            [
                "7470e87bc569f9a8"
            ]
        ]
    },
    {
        "id": "7470e87bc569f9a8",
        "type": "amqp ack",
        "z": "06c72d44e5729b2a",
        "g": "96db80cb3d51c6c6",
        "name": "",
        "topic": "",
        "iotype": "4",
        "ioname": "wt.transaction",
        "nack": false,
        "server": "73a503547a572f1b",
        "x": 800,
        "y": 1100,
        "wires": [
            []
        ]
    },
    {
        "id": "c2af8c09210a4097",
        "type": "switch",
        "z": "06c72d44e5729b2a",
        "g": "9f1e98d4426d35e3",
        "name": "acknowledge ?",
        "property": "ack",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            },
            {
                "t": "false"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 520,
        "y": 120,
        "wires": [
            [
                "7ab4d9e9b22d944d"
            ],
            [
                "dfc98af8f801f8b3"
            ]
        ]
    },
    {
        "id": "a682597d72837a54",
        "type": "amqp ack",
        "z": "06c72d44e5729b2a",
        "g": "9f1e98d4426d35e3",
        "name": "",
        "topic": "",
        "iotype": "4",
        "ioname": "wt.tracking.perdevice",
        "nack": true,
        "server": "0a8b482f55e0592d",
        "x": 760,
        "y": 200,
        "wires": [
            []
        ]
    },
    {
        "id": "dfc98af8f801f8b3",
        "type": "function",
        "z": "06c72d44e5729b2a",
        "g": "9f1e98d4426d35e3",
        "name": "not acknowlege",
        "func": "msg = msg.ori;\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 740,
        "y": 160,
        "wires": [
            [
                "a682597d72837a54"
            ]
        ]
    },
    {
        "id": "89a5b43359f7baa0",
        "type": "switch",
        "z": "06c72d44e5729b2a",
        "g": "9f1e98d4426d35e3",
        "name": "geoDivision",
        "property": "geoDivision",
        "propertyType": "msg",
        "rules": [
            {
                "t": "nnull"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 510,
        "y": 200,
        "wires": [
            [
                "e8c0683cc5f8df67"
            ]
        ]
    },
    {
        "id": "19bc5810b2b9aee7",
        "type": "amqp ack",
        "z": "06c72d44e5729b2a",
        "g": "9f1e98d4426d35e3",
        "name": "",
        "topic": "",
        "iotype": "4",
        "ioname": "wt.tracking.perdevice",
        "nack": false,
        "server": "0a8b482f55e0592d",
        "x": 760,
        "y": 120,
        "wires": [
            []
        ]
    },
    {
        "id": "7ab4d9e9b22d944d",
        "type": "function",
        "z": "06c72d44e5729b2a",
        "g": "9f1e98d4426d35e3",
        "name": "acknowlege",
        "func": "msg = msg.ori;\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 730,
        "y": 80,
        "wires": [
            [
                "19bc5810b2b9aee7"
            ]
        ]
    },
    {
        "id": "4a5542470e78ff1f",
        "type": "switch",
        "z": "06c72d44e5729b2a",
        "g": "bf7019fa94e27678",
        "name": "acknowledge ?",
        "property": "ack",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            },
            {
                "t": "false"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 440,
        "y": 400,
        "wires": [
            [
                "8294a49c8a909b6f"
            ],
            [
                "07e925cecf4e0f11"
            ]
        ]
    },
    {
        "id": "aaf76430a76d8abc",
        "type": "switch",
        "z": "06c72d44e5729b2a",
        "g": "bf7019fa94e27678",
        "name": "ack is empty",
        "property": "ack",
        "propertyType": "msg",
        "rules": [
            {
                "t": "empty"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 430,
        "y": 480,
        "wires": [
            [
                "f837821d76ab526d"
            ]
        ]
    },
    {
        "id": "084f166599dd9ab2",
        "type": "switch",
        "z": "06c72d44e5729b2a",
        "g": "8913e09cb6434789",
        "name": "acknowledge ?",
        "property": "ack",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            },
            {
                "t": "false"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 420,
        "y": 900,
        "wires": [
            [
                "5a370e3921d66ad8"
            ],
            [
                "eb6b615b54e9fd61"
            ]
        ]
    },
    {
        "id": "5a370e3921d66ad8",
        "type": "function",
        "z": "06c72d44e5729b2a",
        "g": "8913e09cb6434789",
        "name": "acknowlege",
        "func": "msg = msg.ori;\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 630,
        "y": 880,
        "wires": [
            [
                "6d5542a7141c4672"
            ]
        ]
    },
    {
        "id": "6d5542a7141c4672",
        "type": "amqp ack",
        "z": "06c72d44e5729b2a",
        "g": "8913e09cb6434789",
        "name": "",
        "topic": "",
        "iotype": "4",
        "ioname": "wt.tracking.filterby.tree",
        "nack": false,
        "server": "94497583e5725ee2",
        "x": 840,
        "y": 880,
        "wires": [
            []
        ]
    },
    {
        "id": "eb6b615b54e9fd61",
        "type": "function",
        "z": "06c72d44e5729b2a",
        "g": "8913e09cb6434789",
        "name": "not acknowlege",
        "func": "msg = msg.ori;\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 640,
        "y": 920,
        "wires": [
            [
                "32bb7db17bf0aae4"
            ]
        ]
    },
    {
        "id": "32bb7db17bf0aae4",
        "type": "amqp ack",
        "z": "06c72d44e5729b2a",
        "g": "8913e09cb6434789",
        "name": "",
        "topic": "",
        "iotype": "4",
        "ioname": "wt.tracking.filterby.tree",
        "nack": true,
        "server": "94497583e5725ee2",
        "x": 860,
        "y": 920,
        "wires": [
            []
        ]
    },
    {
        "id": "bafc614fbcb82f02",
        "type": "switch",
        "z": "06c72d44e5729b2a",
        "g": "675a034d3ec876e6",
        "name": "acknowledge ?",
        "property": "ack",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            },
            {
                "t": "false"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 440,
        "y": 700,
        "wires": [
            [
                "556efb3bcd5fb373",
                "8ab2f8087937a815"
            ],
            [
                "3e8b4e6ffc5eb9a4"
            ]
        ]
    },
    {
        "id": "7caf168b939b9028",
        "type": "amqp in",
        "z": "9ba7388927fccc31",
        "g": "89ff6cae3b742adc",
        "name": "",
        "topic": "",
        "iotype": "4",
        "ioname": "wt.smarttimeseries.to.redistimeseries",
        "server": "e907ba5364e5896f",
        "x": 190,
        "y": 380,
        "wires": [
            [
                "bb6860a59623cd4b"
            ]
        ]
    },
    {
        "id": "bb6860a59623cd4b",
        "type": "function",
        "z": "9ba7388927fccc31",
        "g": "89ff6cae3b742adc",
        "name": "chunk data",
        "func": "let payload = msg.payload;\n\nconst chunkSize = 1000;\nconst delayBetweenChunks = 1000;\n\nfunction processArrayWithDelay(startIndex) {\n  const endIndex = Math.min(startIndex + chunkSize, payload.length);\n  const chunk = payload.slice(startIndex, endIndex);\n\n  node.send({\n    payload: chunk\n  });\n\n  if (endIndex < payload.length) {\n    setTimeout(() => {\n      processArrayWithDelay(endIndex);\n    }, delayBetweenChunks);\n  }\n}\n\n// Start processing the array with a delay\nprocessArrayWithDelay(0);\nreturn null;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 270,
        "y": 420,
        "wires": [
            [
                "bafc0bcaf316df35"
            ]
        ],
        "icon": "node-red/status.svg"
    },
    {
        "id": "f449ebb8cc8d7088",
        "type": "function",
        "z": "9ba7388927fccc31",
        "g": "89ff6cae3b742adc",
        "name": "build create & add commands",
        "func": "const redisTS = global.get('redisTS');\nlet ori = msg.payload;\n\nredisTS.commands([['keys', 'wt:*']]).then(rs => {\n    let wtKeys = rs.data[0];\n    let payload = msg.payload;\n    let suffix = ['deviceDatetime', 'latitude', 'longitude', 'altitude', 'speed', 'event', 'battery'];\n    let addCommands = [];\n    let createPayload = [];\n\n    for (const rec of payload) {\n        let { deviceID, deviceDatetime, latitude, longitude, altitude, event, speed, battery } = rec;\n        if (deviceDatetime && deviceDatetime != null && deviceDatetime != \"\") {\n            suffix.forEach(suf => {\n                if (!wtKeys.includes(`wt:${deviceID}:${suf}`) && createPayload.find(x => x.key == `wt:${deviceID}:${suf}`) == undefined) {\n                    createPayload.push({\n                        key: `wt:${deviceID}:${suf}`,\n                        retention: 0,\n                        duplicatePolicy: (suf != 'event') ? 'LAST' : 'SUM',\n                        labels: ['type', 'worker-tracker', 'deviceID', deviceID, 'topic', suf],\n                        encoding: 'UNCOMPRESSED'\n                    });\n                }\n            })\n            addCommands.push([\n                'TS.ADD',\n                `wt:${deviceID}:deviceDatetime`,\n                new Date(deviceDatetime).getTime().toString(),\n                new Date(deviceDatetime).getTime().toString()\n            ]);\n            addCommands.push([\n                'TS.ADD',\n                `wt:${deviceID}:latitude`,\n                new Date(deviceDatetime).getTime().toString(),\n                parseFloat(latitude).toString()\n            ]);\n            addCommands.push([\n                'TS.ADD',\n                `wt:${deviceID}:longitude`,\n                new Date(deviceDatetime).getTime().toString(),\n                parseFloat(longitude).toString()\n            ]);\n            addCommands.push([\n                'TS.ADD',\n                `wt:${deviceID}:altitude`,\n                new Date(deviceDatetime).getTime().toString(),\n                parseFloat(altitude).toString()\n            ]);\n            addCommands.push([\n                'TS.ADD',\n                `wt:${deviceID}:speed`,\n                new Date(deviceDatetime).getTime().toString(),\n                parseFloat(speed).toString()\n            ]);\n            addCommands.push([\n                'TS.ADD',\n                `wt:${deviceID}:event`,\n                new Date(deviceDatetime).getTime().toString(),\n                parseFloat(event).toString()\n            ]);\n            addCommands.push([\n                'TS.ADD',\n                `wt:${deviceID}:battery`,\n                new Date(deviceDatetime).getTime().toString(),\n                parseFloat(battery).toString()\n            ]);\n        }\n    }\n\n    redisTS.tsCreate(createPayload).then(createRS => {\n        msg.payload = addCommands;\n        node.send(msg);\n    }, (err) => {\n        node.send({\n            payload: ori,\n            error: err\n        })\n    });\n}, (err) => {\n    node.send({\n        payload: ori,\n        error: err\n    })\n});",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 530,
        "y": 500,
        "wires": [
            [
                "e057ad1e131c55ee",
                "dce20e17ce373f6d"
            ]
        ],
        "icon": "font-awesome/fa-code-fork"
    },
    {
        "id": "e057ad1e131c55ee",
        "type": "function",
        "z": "9ba7388927fccc31",
        "g": "89ff6cae3b742adc",
        "name": "ts.add data series",
        "func": "try {\n    if (msg.error == undefined) {\n        const w = global.get('worker');\n        const worker = new w.Worker('./workers/w-redis-ts.js', { workerData: 'send data csv to timeseries' });\n\n        worker.on('message', (result) => {\n            worker.terminate();\n            node.send({ payload: result });\n        });\n        worker.on('error', (err) => {\n            worker.terminate();\n            node.send({\n                payload: msg.payload,\n                error: err\n            })\n        })\n\n        // Send a message to the worker thread\n        worker.postMessage({\n            func: 'commands',\n            payload: msg.payload\n        });\n    }\n} catch (err) {\n    node.send({\n        payload: msg.payload,\n        error: err\n    })\n}",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 570,
        "y": 540,
        "wires": [
            [
                "dce20e17ce373f6d"
            ]
        ],
        "icon": "font-awesome/fa-qrcode"
    },
    {
        "id": "3fcc35deba3e1da9",
        "type": "amqp in",
        "z": "9ba7388927fccc31",
        "g": "89ff6cae3b742adc",
        "name": "",
        "topic": "",
        "iotype": "4",
        "ioname": "wt.series.chunk",
        "server": "56e870f2a20cabb0",
        "x": 260,
        "y": 500,
        "wires": [
            [
                "f449ebb8cc8d7088"
            ]
        ]
    },
    {
        "id": "bafc0bcaf316df35",
        "type": "amqp out",
        "z": "9ba7388927fccc31",
        "g": "89ff6cae3b742adc",
        "name": "",
        "routingkey": "",
        "iotype": "4",
        "ioname": "wt.series.chunk",
        "server": "f7b36a35cf0d6417",
        "x": 480,
        "y": 420,
        "wires": []
    },
    {
        "id": "e3a50e6cb96cc3b3",
        "type": "amqp in",
        "z": "9ba7388927fccc31",
        "g": "48e7b095e8d92958",
        "name": "",
        "topic": "",
        "iotype": "4",
        "ioname": "wt.smartbucket.to.smarttimeseries",
        "server": "5471df75ac676292",
        "x": 180,
        "y": 120,
        "wires": [
            [
                "dd42509446494f20"
            ]
        ]
    },
    {
        "id": "dd42509446494f20",
        "type": "function",
        "z": "9ba7388927fccc31",
        "g": "48e7b095e8d92958",
        "name": "bulk insert",
        "func": "const couchdb = global.get('couchdb');\n\ncouchdb.bulk('smart-timeseries', msg.payload)\n    .then(() => { }, (err) => {\n        node.send({\n            payload: msg.payload,\n            error: err\n        })\n    })\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 250,
        "y": 160,
        "wires": [
            [
                "248c25e4d88ba52f"
            ]
        ]
    },
    {
        "id": "248c25e4d88ba52f",
        "type": "switch",
        "z": "9ba7388927fccc31",
        "g": "48e7b095e8d92958",
        "name": "error ? ",
        "property": "error",
        "propertyType": "msg",
        "rules": [
            {
                "t": "nnull"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 430,
        "y": 160,
        "wires": [
            [
                "c7bc8f0da817a8a1",
                "d2ee66a5416bd52f"
            ]
        ]
    },
    {
        "id": "c7bc8f0da817a8a1",
        "type": "debug",
        "z": "9ba7388927fccc31",
        "g": "48e7b095e8d92958",
        "name": "debug 4",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "error",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 600,
        "y": 160,
        "wires": []
    },
    {
        "id": "1035dda52d64f81f",
        "type": "amqp out",
        "z": "9ba7388927fccc31",
        "g": "48e7b095e8d92958",
        "name": "",
        "routingkey": "",
        "iotype": "4",
        "ioname": "wt.smartbucket.to.smarttimeseries",
        "server": "f7b36a35cf0d6417",
        "x": 680,
        "y": 240,
        "wires": []
    },
    {
        "id": "d2ee66a5416bd52f",
        "type": "function",
        "z": "9ba7388927fccc31",
        "g": "48e7b095e8d92958",
        "name": "send back payload",
        "func": "let {payload} = msg.payload;\nmsg.payload = payload;\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 630,
        "y": 200,
        "wires": [
            [
                "1035dda52d64f81f"
            ]
        ]
    },
    {
        "id": "dce20e17ce373f6d",
        "type": "switch",
        "z": "9ba7388927fccc31",
        "g": "89ff6cae3b742adc",
        "name": "error ? ",
        "property": "error",
        "propertyType": "msg",
        "rules": [
            {
                "t": "nnull"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 770,
        "y": 500,
        "wires": [
            [
                "55430bbd67084deb",
                "bd7d3d7fe33f261b"
            ]
        ]
    },
    {
        "id": "55430bbd67084deb",
        "type": "debug",
        "z": "9ba7388927fccc31",
        "g": "89ff6cae3b742adc",
        "name": "debug 9",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "error",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 940,
        "y": 460,
        "wires": []
    },
    {
        "id": "36bbf34f8f4ec2ac",
        "type": "amqp out",
        "z": "9ba7388927fccc31",
        "g": "89ff6cae3b742adc",
        "name": "",
        "routingkey": "",
        "iotype": "4",
        "ioname": "wt.series.chunk",
        "server": "f7b36a35cf0d6417",
        "x": 960,
        "y": 540,
        "wires": []
    },
    {
        "id": "bd7d3d7fe33f261b",
        "type": "function",
        "z": "9ba7388927fccc31",
        "g": "89ff6cae3b742adc",
        "name": "send back payload",
        "func": "let {payload} = msg.payload;\nmsg.payload = payload;\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 970,
        "y": 500,
        "wires": [
            [
                "36bbf34f8f4ec2ac"
            ]
        ]
    },
    {
        "id": "0337520c937b5a0c",
        "type": "comment",
        "z": "9ba7388927fccc31",
        "name": "",
        "info": "## wt.csv.import\n1 message / 5 seconds\n\n## wt.csv.import.chunk\n1 message / 10 seconds",
        "x": 80,
        "y": 40,
        "wires": []
    }
]